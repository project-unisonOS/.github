name: reusable-container-supply-chain

on:
  workflow_call:
    inputs:
      image-name:
        required: true
        type: string
      dockerfile:
        required: false
        type: string
        default: Dockerfile
      context:
        required: false
        type: string
        default: .
      registry:
        required: false
        type: string
        default: ghcr.io
      enable-signing:
        required: false
        type: boolean
        default: true
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Login to registry
        if: ${{ secrets.REGISTRY_USERNAME != '' && secrets.REGISTRY_PASSWORD != '' }}
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: false
          load: true
          tags: ${{ inputs.registry }}/${{ github.repository }}:${{ github.sha }}

      - name: SBOM (syft)
        uses: anchore/sbom-action@43a17d6e7add2b5535efe4dcae9952337c479a93 # v0
        with:
          image: ${{ inputs.registry }}/${{ github.repository }}:${{ github.sha }}
          artifact-name: sbom-${{ github.event.repository.name }}.spdx.json

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: ${{ inputs.registry }}/${{ github.repository }}:${{ github.sha }}
          ignore-unfixed: true
          format: table
          exit-code: "1"
          vuln-type: "os,library"

      - name: Install Cosign
        if: ${{ inputs.enable-signing }}
        uses: sigstore/cosign-installer@59acb6260d9c0ba8f4a2f9d9b48431a222b68e20 # v3.5.0

      - name: Cosign sign (keyless)
        if: ${{ inputs.enable-signing }}
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign sign --yes ${{ inputs.registry }}/${{ github.repository }}:${{ github.sha }}
