name: reusable-python-security

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version to use
        required: false
        default: "3.11"
      enable-bandit:
        description: Run bandit SAST
        required: false
        default: true
      enable-semgrep:
        description: Run semgrep SAST
        required: false
        default: true
      bandit-skips:
        description: Comma-separated Bandit rule IDs to skip (e.g., B101,B110)
        required: false
        default: ""
      working-directory:
        description: Optional working directory
        required: false
        default: "."

permissions:
  contents: read
  id-token: write

jobs:
  lint-test-scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f constraints.txt ]; then pip install -c constraints.txt -r requirements.txt 2>/dev/null || true; fi
          pip install pytest pytest-cov
          pip install bandit==1.7.9
          pip install semgrep==1.77.0

      - name: Lint/format (ruff if present, fallback to flake8)
        run: |
          if [ -f pyproject.toml ] && grep -q \"ruff\" pyproject.toml; then
            pip install ruff==0.8.4
            ruff check .
          elif python - <<'PY' 2>/dev/null; import importlib.util as s; exit(0 if s.find_spec('flake8') else 1); PY; then
            flake8 .
          else
            echo \"No Python linter configured; skipping\"; fi

      - name: Tests
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pytest --maxfail=1 --disable-warnings -q
          else
            echo \"No tests detected; skipping\"
          fi

      - name: Bandit (SAST)
        if: ${{ inputs.enable-bandit == 'true' }}
        run: |
          if [ -n "${{ inputs.bandit-skips }}" ]; then
            bandit -q -r . --skip "${{ inputs.bandit-skips }}"
          else
            bandit -q -r .
          fi

      - name: Semgrep (SAST)
        if: ${{ inputs.enable-semgrep == 'true' }}
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          semgrep ci --config p/auto --enable-metrics=auto || semgrep scan --config p/auto --enable-metrics=auto

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          scan-type: fs
          ignore-unfixed: true
          format: table
          exit-code: "1"
          vuln-type: "os,library"

      - name: SBOM (syft)
        uses: anchore/sbom-action@43a17d6e7add2b5535efe4dcae9952337c479a93 # v0
        with:
          path: ${{ inputs.working-directory }}
          artifact-name: sbom-${{ github.event.repository.name }}.spdx.json
